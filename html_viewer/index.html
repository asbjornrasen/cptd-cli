<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CPTD Viewer</title>
  <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
  <style>
    body{font-family:system-ui,sans-serif;background:#f5f5f5;color:#111;margin:0}
    header{background:#222;color:#fff;text-align:center;padding:1rem}
    main{max-width:1200px;margin:auto;padding:1rem}
    label#pickLabel{display:inline-block;background:#007bff;color:#fff;padding:0.5rem 1rem;border-radius:0.5rem;margin-top:1rem;cursor:pointer}
    input[type=file]{display:none}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:1rem}
    .card{background:#fff;padding:1rem;border-radius:1rem;box-shadow:0 2px 6px rgba(0,0,0,.1);position:relative}
    .card[data-status=hold]{opacity:.65}
    .card[data-status=stop]{text-decoration:line-through;opacity:.6}

    /* üé® –¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ —Ü–µ–ª–µ–π –∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ */
    .card[data-status=active] {background:#e8f8e8;}
    .card[data-status=hold]   {background:#e7f1ff;opacity:1;}   /* —É–±—Ä–∞–ª–∏ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
    .card[data-status=stop]   {background:#ffeaea;}             /* –æ—Å—Ç–∞–≤–∏–ª–∏ –∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç */


    /* üé® –¶–≤–µ—Ç–∞ —Å–≤–æ–¥–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .card.status-active {background:#e8f8e8;border:1px solid #b7e7b7;}
    .card.status-hold   {background:#e7f1ff;border:1px solid #b6d1ff;}
    .card.status-stop   {background:#ffeaea;border:1px solid #ffbaba;}
    .card.status-done   {background:#f4f4f4;border:1px solid #d9d9d9;}

    /* üé® –°–≤–æ–¥–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ ¬´–≤—Å—ë¬ª */
    .card.status-summary {
      background:#fffef6;              /* –º—è–≥–∫–∏–π —Ñ–æ–Ω */
      border:1px solid #e6dfb9;
    }
    .card.status-summary h3 {margin-bottom:0.4rem}
    .card.status-summary p  {font-size:1.1rem;font-weight:600;margin:0}



    canvas{display:none;margin:2rem auto;background:#fff;border-radius:1rem;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,.1);max-width:600px}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{border-bottom:1px solid #ccc;padding:0.5rem;font-size:0.85rem}
    th{background:#eee}
    #filterWrap{margin-top:1rem}
    #filterWrap select{padding:0.4rem;border-radius:0.3rem}
    form#addForm{margin-top:2rem;background:#fff;padding:1rem 1.5rem;border-radius:1rem;box-shadow:0 2px 6px rgba(0,0,0,.1);display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem}
    form#addForm input,form#addForm select{width:100%;padding:.4rem .6rem;border:1px solid #ccc;border-radius:.4rem}
    form#addForm button{grid-column:1/-1;padding:.6rem 1rem;border:none;background:#007bff;color:#fff;border-radius:.5rem;cursor:pointer}

    .today-summary{
      background:#fff3cd;
      border:1px solid #ffecb5;
    }
    .today-summary h3{
      margin:0 0 .4rem 0;
    }


  </style>
</head>
<body>
<header>
  <h1>üìä CPTD Viewer</h1>
  <p>Processing occurs locally, files are not sent anywhere</p>
  <label id="pickLabel">Select CPTD folder</label>
  <input type="file" id="dirPicker" webkitdirectory multiple />
</header>
<section id="todayBar" class="card today-summary" style="display:none;max-width:1200px;margin:1rem auto;">
  <!-- –∑–∞–ø–æ–ª–Ω–∏–º –∏–∑ JS -->
</section>

<main>
  <section id="goalsOverview" class="grid" style="display:none"></section>
  <section id="stats" class="grid" style="display:none">
    <!-- –°–≤–æ–¥–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <div id="summaryCard" class="card status-summary"><h3>Summary</h3><p id="summaryCnt">‚Äî</p></div>

    <div class="card status-done"><h3>Files</h3><p id="fileCnt">0</p></div>
    <div class="card status-done"><h3>Total tasks</h3><p id="taskCnt">0</p></div>
    <div class="card status-done"><h3>Done</h3><p id="doneCnt">0</p></div>
    <div class="card status-active"><h3>Actively</h3><p id="actCnt">0</p></div>
    <div class="card status-hold"><h3>Pause</h3><p id="holdCnt">0</p></div>
    <div class="card status-stop"><h3>Stopped</h3><p id="stopCnt">0</p></div>

  </section>
  <!-- <canvas id="statusChart"></canvas> -->

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤—ã—à–µ —Ç–∞–±–ª–∏—Ü—ã -->
  <form id="addForm" style="display:none">
    <select id="itemType">
      <option value="goal">Goal</option>
      <option value="project">Project</option>
      <option value="task" selected>Task</option>
    </select>
    <input type="text" id="itemName" placeholder="Description / Title" required />
    <select id="parentId" style="display:none">
      <option value="">-- select --</option>
    </select>
    <input type="text" id="dueDate" placeholder="Due (YYYYMMDD)" />
    <div id="idPreview" style="grid-column:1/-1;font-size:0.9rem;color:#444;margin-top:-0.5rem;margin-bottom:0.5rem">ID: ...</div>
    <button type="submit">‚ûï Add</button>
  </form>

  <section id="tblWrap" style="display:none">
    <div id="filterWrap" style="display:flex;align-items:center;gap:1rem">
      <label for="statusFilter">Filter:</label>
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="done">Done</option>
        <option value="hold">Pause</option>
        <option value="stop">Stopped</option>
      </select>
      <span id="selectedGoalInfo" style="font-size:0.9rem;color:#555;margin-left:auto"></span>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>–°—Ç–∞—Ç—É—Å</th><th>Description</th><th>Goal</th><th>Project</th><th>ID</th><th>Priority</th><th>Start</th><th>Due</th><th>Progress</th><th>Method</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>
<script>
// --- –≤–µ—Å—å JavaScript-–∫–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∏–∂–µ ---

const todayStr = new Date().toISOString().slice(0,10).replace(/-/g,''); // '20250605'
let todayTasks = [];
let showToday = false;   // —Ä–µ–∂–∏–º –ø–æ–∫–∞–∑–∞ —Ç–æ–ª—å–∫–æ today-tasks



let selectedGoalId = '';
const PRIORITY={active:0,hold:1,stop:2,done:3};
const statusMap={'[X]':'done','[-]':'hold','[!]':'stop','[*]':'carry'};
const dirPicker=document.getElementById('dirPicker');
const pickBtn=document.getElementById('pickLabel');
const chartEl=document.getElementById('statusChart');
const statusSel=document.getElementById('statusFilter');
const addForm=document.getElementById('addForm');
let rawTasks=[],tasks=[],statusCounts={};
const goalNames=new Map(),projectNames=new Map();
const goalStatus=new Map(),projectStatus=new Map();
let goalsFileHandle=null;
pickBtn.addEventListener('click',async()=>{
  if(window.showDirectoryPicker){
    try{
      const dirHandle=await window.showDirectoryPicker();
      await loadFromDirHandle(dirHandle);
      return;
    }catch(err){
      if(err.name!=='AbortError')console.error(err);
      return;
    }
  }
  dirPicker.click();
});
dirPicker.addEventListener('change',async e=>{
  resetState();
  const files=[...e.target.files];
  if(!files.length)return;
  document.getElementById('fileCnt').textContent=files.length;
  await parseFiles(files);
  propagateStatuses();
  deduplicate();
  renderUI();
});
statusSel.addEventListener('change',renderTable);
addForm.addEventListener('submit',onAddSubmit);
function resetState(){
  rawTasks=[];tasks=[];statusCounts={done:0,active:0,hold:0,stop:0};
  goalNames.clear();projectNames.clear();goalStatus.clear();projectStatus.clear();
  goalsFileHandle=null;
  document.getElementById('goalsOverview').style.display='none';
}
async function loadFromDirHandle(dirHandle){
  resetState();
  const files=[];
  for await(const [name,handle] of dirHandle.entries()){
    if(handle.kind==='file'&&name.match(/\.md$/i)){
      const file=await handle.getFile();
      file.handle=handle;
      files.push(file);
      if(/goals.*\.md$/i.test(name))goalsFileHandle=handle;
    }
  }
  if(!files.length)return alert('Markdown‚Äëfiles not found');
  document.getElementById('fileCnt').textContent=files.length;
  await parseFiles(files);
  propagateStatuses();
  deduplicate();
  renderUI();
}
async function parseFiles(files){
  for (const f of files){
    const txt = await f.text();

    const dayMatch = f.name.match(/^(\d{8})/);   // 20250605_cptd.md ‚Üí '20250605'
    const isToday  = dayMatch && dayMatch[1] === todayStr;   // todayStr –æ–±—ä—è–≤–ª–µ–Ω –≤—ã—à–µ

    if (/goals.*\.md$/i.test(f.name)){
      if (!goalsFileHandle && f.handle) goalsFileHandle = f.handle;
      extractNames(txt);
      parseGoals(txt);

    } else if (dayMatch){        // —ç—Ç–æ daily-—Ñ–∞–π–ª –ª—é–±–æ–π –¥–∞—Ç—ã
      parseDaily(txt, isToday);  // ‚¨Ö –ø–µ—Ä–µ–¥–∞—ë–º –≤—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç!
    }
  }
}

function extractNames(text){
  text.split(/\r?\n/).forEach(l=>{
    const g=l.match(/goals:([^\n]*?)(?=\s\w+:|\s+id:|$)/i);
    const gid=l.match(/id:(G\d+)/i);
    if(g&&gid)goalNames.set(gid[1],g[1].trim());
    const p=l.match(/project:([^\n]*?)(?=\s\w+:|\s+id:|$)/i);
    const pid=l.match(/id:(G\d+_P\d+)/i);
    if(p&&pid)projectNames.set(pid[1],p[1].trim());
  });
}
function parseDaily(text, isToday = false){
  text.split(/\r?\n/).forEach(l=>{
    const m=l.match(/^\s*((?:\[[^\]]*])+)+\s*(.*)/);
    if(!m)return;
    const st=statusMap[m[1].match(/\[[^\]]*]/)[0]]||'active';
    if(st==='carry')return;
    const rest=m[2];
    if(/\bhabit:/i.test(rest))return;
    const obj={status:st};
    rest.split(/\s(?=\w+:)/).forEach(seg=>{
      const[k,...v]=seg.split(':');obj[k.toLowerCase()]=v.join(':').trim();
    });
    if(!obj.task)obj.task=rest;
    if(obj.id){
      const parts=obj.id.split('_');
      obj.goalId=parts[0];
      obj.projectId=parts.length>=2?parts[0]+'_'+parts[1]:'';
    }
    rawTasks.push(obj);
    if (isToday) todayTasks.push(obj);   // ‚ú® —Å–æ–±–∏—Ä–∞–µ–º –¥–ª—è —Å–≤–æ–¥–∫–∏
  });
}
function parseGoals(text){
  let curGoalId='',curGoalSt='active';
  text.split(/\r?\n/).forEach(line=>{
    const m=line.match(/^\s*(?:#+\s*)?((?:\[[^\]]*])+)(.*)/);
    if(!m)return;
    const stToken=m[1].match(/\[[^\]]*]/)[0];
    const baseStatus=statusMap[stToken]||'active';
    if(baseStatus==='carry')return;
    const rest=m[2].trim();
    const obj={status:baseStatus};
    rest.split(/\s(?=\w+:)/).forEach(seg=>{
      const[k,...v]=seg.split(':');obj[k.toLowerCase()]=v.join(':').trim();
    });
    if(!obj.task)obj.task=rest;
    if(obj.goals&&obj.id?.startsWith('G')){
      curGoalId=obj.id;curGoalSt=baseStatus;goalStatus.set(curGoalId,curGoalSt);return;
    }
    if(obj.project && obj.id?.includes('_P')) {
      const projId = obj.id;
      const inherited = ['hold','stop'].includes(curGoalSt) ? curGoalSt : baseStatus;
      projectStatus.set(projId, inherited);
      projectStatus.set(projId.split('_').slice(0,2).join('_'), inherited);
      if (!projectNames.has(projId)) {
        projectNames.set(projId, obj.project.trim());
      }
      return;
    }
    if (obj.id && (rest.includes('task:') || rest.startsWith('task'))) {
      const parts = obj.id.split('_');
      const goalId = parts[0];
      const projId = parts.length >= 2 ? parts[0] + '_' + parts[1] : '';
      obj.goalId = goalId;
      obj.projectId = projId;
      obj.project = projectNames.get(projId) || obj.project || '';
      obj.goals = goalNames.get(goalId) || obj.goals || '';
      if (!projectNames.has(projId) && obj.project) {
        projectNames.set(projId, obj.project.trim());
      }
      const gStat = goalStatus.get(goalId);
      const pStat = projectStatus.get(projId);
      if (['hold', 'stop'].includes(gStat)) obj.status = gStat;
      else if (['hold', 'stop'].includes(pStat)) obj.status = pStat;
      rawTasks.push(obj);
    }
  });
}
function propagateStatuses(){
  rawTasks.forEach(t=>{
    if(!t.id)return;
    const projId=t.id.includes('_')?t.id.split('_').slice(0,2).join('_'):'';
    const goalId=t.id.split('_')[0];
    const pStat=projectStatus.get(projId);
    const gStat=goalStatus.get(goalId);
    if(['hold','stop'].includes(gStat))t.status=gStat;
    else if(['hold','stop'].includes(pStat))t.status=pStat;
  });
}
function deduplicate(){
  const map=new Map();
  rawTasks.forEach(t=>{
    const gSt=goalStatus.get(t.goalId);
    const pSt=projectStatus.get(t.projectId);
    if(gSt==='done'||gSt==='archive')return;
    if(pSt==='done'||pSt==='archive')return;
    const key=t.id||Symbol();
    if(map.has(key)){
      if(PRIORITY[t.status]>PRIORITY[map.get(key).status])map.set(key,t);
    }else map.set(key,t);
  });
  tasks=[...map.values()];
  statusCounts={done:0,active:0,hold:0,stop:0};
  tasks.forEach(t=>statusCounts[t.status]++);
}
function renderUI(){
  if(!tasks.length)return alert('There are no tasks to display.');
  document.getElementById('taskCnt').textContent=tasks.length;
  document.getElementById('doneCnt').textContent=statusCounts.done;
  document.getElementById('actCnt').textContent=statusCounts.active;
  document.getElementById('holdCnt').textContent=statusCounts.hold;
  document.getElementById('stopCnt').textContent=statusCounts.stop;
  // –ù–û–í–û–ï: –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
  document.getElementById('summaryCnt').textContent =
    `–í—Å–µ –∫–∞—Ä—Ç—ã`;
  document.getElementById('stats').style.display='grid';
  renderTodayBar();renderGoalsOverview();renderTable();
  // renderChart();
  if(goalsFileHandle)addForm.style.display='grid';
  updateParentOptions();
  console.log("Goals:", [...goalNames.entries()]);
  console.log("Projects:", [...projectNames.entries()]);
}
function renderGoalsOverview() {
  const wrap = document.getElementById('goalsOverview');
  wrap.innerHTML = '';

  // 1) —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ü–µ–ª–µ–π –ø–æ —á–∏—Å–ª—É –≤ ID (G001, G002 ‚Ä¶)
  const goalsOverview = [...goalStatus.entries()]
    .map(([id, st]) => ({ id, status: st, name: goalNames.get(id) || id }))
    .sort((a, b) => Number(a.id.slice(1)) - Number(b.id.slice(1)));   // ‚Üê –∑–∞–º–µ–Ω–∏–ª–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É

  goalsOverview.forEach(g => {
    const div = document.createElement('div');
    div.className = 'card';
    div.dataset.status = g.status;

    // 2) —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ —Ç–æ–π –∂–µ —Ü–µ–ª–∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–æ–º–µ—Ä—É _P01, _P02 ‚Ä¶
    const projects = [...projectNames.entries()]
      .filter(([pid]) => pid.startsWith(g.id + '_'))
      .sort((a, b) => {                    // a –∏ b ‚Äì –º–∞—Å—Å–∏–≤—ã [pid, pname]
        const num = str => Number(str[0].split('_P')[1]);   // –≤—ã—Ç—è–Ω—É—Ç—å —á–∏—Å–ª–æ –ø–æ—Å–ª–µ _P
        return num(a) - num(b);
      })
      .map(([pid, pname]) => `<li>${pname} <small>(${pid})</small></li>`)
      .join('');

    div.innerHTML = `
      <h4>${g.name}</h4>
      <p>ID: ${g.id}</p>
      <p><strong>${g.status}</strong></p>
      ${projects ? `<details><summary>projects</summary><ul>${projects}</ul></details>` : ''}
    `;

    // (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    div.addEventListener('click', () => {
      const isActive = div.classList.toggle('active');
      document.querySelectorAll('#goalsOverview .card.active')
              .forEach(card => { if (card !== div) card.classList.remove('active'); });

      const label = document.getElementById('selectedGoalInfo');
      if (isActive) {
        label.textContent = `Target: ${g.name} (ID: ${g.id})`;
        statusSel.value = 'all';
        renderTable([g.id]);
        selectedGoalId = g.id;
        showToday = false;

      } else {
        label.textContent = '';
        renderTable();
        selectedGoalId = '';
        showToday = false;

      }
      updateParentOptions();
    });

    wrap.appendChild(div);
  });

  if (goalsOverview.length) wrap.style.display = 'grid';
}


function renderTable(filterIds){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';

  // ‚ë† –ù–∞—á–∏–Ω–∞–µ–º —Å–æ –≤—Å–µ—Ö –∑–∞–¥–∞—á
  let view = tasks.slice();
  if (showToday) view = todayTasks.slice();


  // ‚ë° –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Ü–µ–ª—å –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∏—Ö
  if (filterIds && filterIds.length){
    view = view.filter(t => filterIds.includes(t.goalId));
  }

  // ‚ë¢ –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
  const filter = statusSel.value;  // all / active / hold / stop / done / inactive

  if (filter !== 'all'){
    if (filter === 'inactive'){
      view = view.filter(t => ['done','hold','stop'].includes(t.status));
    } else {
      view = view.filter(t => t.status === filter);
    }
  }

  // ‚ë£ –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ç—Ä–æ–∫–∏
  view.forEach(t => {
    const goal = goalNames.get(t.goalId)   || t.goals   || '';
    const proj = projectNames.get(t.projectId) || t.project || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.status}</td><td>${t.task||''}</td>
      <td>${goal}</td><td>${proj}</td><td>${t.id||''}</td>
      <td>${t.pri||''}</td><td>${t.start||''}</td>
      <td>${t.due||''}</td><td>${t.progress||''}</td><td>${t.method||''}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('tblWrap').style.display = 'block';
}

function renderTodayBar(){
  const bar = document.getElementById('todayBar');
  if (!todayTasks.length){
    bar.style.display = 'none';
    return;
  }

  // —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
  const cnt = { active:0, hold:0, stop:0, done:0 };
  todayTasks.forEach(t => cnt[t.status]++);

  bar.innerHTML = `
    <h3>Today (${todayStr.replace(/^(\\d{4})(\\d{2})(\\d{2})$/, '$3.$2.$1')})</h3>
    <p>
      Actively: <strong>${cnt.active}</strong> |
      Pause: <strong>${cnt.hold}</strong> |
      Stopped: <strong>${cnt.stop}</strong> |
      Done: <strong>${cnt.done}</strong>
    </p>
  `;
  bar.style.display = 'block';
}


// function renderChart(){
//   chartEl.style.display='block';
//   new Chart(chartEl,{type:'bar',data:{labels:['–í—ã–ø–æ–ª–Ω–µ–Ω–æ','–ê–∫—Ç–∏–≤–Ω–æ','–ü–∞—É–∑–∞','–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'],datasets:[{data:[statusCounts.done,statusCounts.active,statusCounts.hold,statusCounts.stop]}]},options:{plugins:{legend:{display:false}},responsive:true}});
// }
async function onAddSubmit(e){
  e.preventDefault();
  if(!goalsFileHandle)return alert('Recording is not available in this mode.');
  const type=document.getElementById('itemType').value;
  const name=document.getElementById('itemName').value.trim();
  const parentId=document.getElementById('parentId').value.trim();
  const due=document.getElementById('dueDate').value.trim();
  if(!name)return alert('Enter a description');
  const id=generateNewId(type,parentId);
  let line='';
  if (type === 'task') {
    if (!parentId) return alert('Need parent project ID');
    line = `\t\t[][] task:${name} id:${id}` + (due ? ` due:${due}` : '');
    const file = await goalsFileHandle.getFile();
    const content = await file.text();
    const lines = content.split(/\r?\n/);
    const projectRegex = new RegExp(
      String.raw`^\s*(?:\[[^\]]*])*\s*project:.*?\bid:${parentId}\b`,  // i-—Ñ–ª–∞–≥ –Ω–∏–∂–µ
      'i'
    );

    const taskRegex = new RegExp(
      String.raw`^\s*(?:\[[^\]]*])*\s*task:.*?\bid:${parentId}_T\d+\b`,
      'i'
    );
    let insertIndex = -1;
    for (let i = 0; i < lines.length; i++) {
      if (projectRegex.test(lines[i])) {
        insertIndex = i + 1;
        for (let j = i + 1; j < lines.length; j++) {
          if (taskRegex.test(lines[j])) {
            insertIndex = j + 1;
          } else if (/^\\s*\\[\\[.*?\\]\\]\\s+(project:|goals:)/.test(lines[j])) {
            break;
          }
        }
        break;
      }
    }
    if (insertIndex === -1) return alert('Project ID not found or the structure is broken.');
    lines.splice(insertIndex, 0, line);
    const newContent = lines.join('\n');
    const writable = await goalsFileHandle.createWritable();
    await writable.write(newContent);
    await writable.close();
    alert('Added! Reload data.');
    return;
  }
  if (type==='goal') {
    line = `### [][]goals:${name} id:${id}` + (due ? ` due:${due}` : '');
  } else if (type==='project') {
    if (!parentId) return alert('Need parent goal ID');
    line = `\t[][] project:${name} id:${id}` + (due ? ` due:${due}` : '');
  }
  const file = await goalsFileHandle.getFile();
  const text = await file.text();
  const writable = await goalsFileHandle.createWritable();
  await writable.write(text + '\n' + line + '\n');
  await writable.close();
  alert('Added! Reload data.');
}
function generateNewId(type,parent){
  const ids=[...goalNames.keys(),...projectNames.keys(),...rawTasks.map(t=>t.id).filter(Boolean)];
  if(type==='goal'){
    const nums=ids.map(i=>/^G(\d+)/.exec(i)?.[1]).filter(Boolean).map(Number);
    const next=nums.length?Math.max(...nums)+1:1;
    return`G${String(next).padStart(3,'0')}`;
  }
  if(type==='project'){
    const base=parent;
    const regex=new RegExp(`^${base}_P(\\d+)`);
    const nums=ids.map(i=>regex.exec(i)?.[1]).filter(Boolean).map(Number);
    const next=nums.length?Math.max(...nums)+1:1;
    return`${base}_P${String(next).padStart(2,'0')}`;
  }
  if(type==='task'){
    const base=parent;
    const regex=new RegExp(`^${base}_T(\\d+)`);
    const nums=ids.map(i=>regex.exec(i)?.[1]).filter(Boolean).map(Number);
    const next=nums.length?Math.max(...nums)+1:1;
    return`${base}_T${String(next).padStart(2,'0')}`;
  }
  return'UNKNOWN';
}
function updateIdPreview(){
  const type = document.getElementById('itemType').value;
  const parentId = document.getElementById('parentId').value.trim();
  const id = generateNewId(type, parentId);
  document.getElementById('idPreview').textContent = `ID –±—É–¥–µ—Ç: ${id}`;
}
document.getElementById('itemType').addEventListener('change', () => {
  updateParentOptions();
  updateIdPreview();
});

document.getElementById('parentId').addEventListener('input', updateIdPreview);
document.getElementById('itemName').addEventListener('input', updateIdPreview);
// ‚îÄ‚îÄ –∫–ª–∏–∫ –ø–æ ¬´–°–≤–æ–¥–∫–µ¬ª: —Å–Ω–∏–º–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ ‚îÄ‚îÄ
document.getElementById('summaryCard').addEventListener('click', () => {
  // 1. –°–±—Ä–æ—Å –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ü–µ–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
  document.querySelectorAll('#goalsOverview .card.active')
          .forEach(c => c.classList.remove('active'));

  // 2. –°–±—Ä–æ—Å –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö/–ª–µ–π–±–ª–æ–≤
  selectedGoalId = '';
  document.getElementById('selectedGoalInfo').textContent = '';

  // 3. –°—Ç–∞–≤–∏–º —Ñ–∏–ª—å—Ç—Ä ¬´all¬ª (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω hold/active –∏ —Ç.–ø.)
  statusSel.value = 'all';

  showToday = false;

  // 4. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
  renderTable();

  // 5. (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ parent-ID –≤ —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
  updateParentOptions();
});


document.getElementById('todayBar').addEventListener('click', () => {
  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Ü–µ–ª–µ–π
  document.querySelectorAll('#goalsOverview .card.active')
          .forEach(c => c.classList.remove('active'));

  selectedGoalId = '';
  document.getElementById('selectedGoalInfo').textContent = '';

  // —Å–Ω–∏–º–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç—É—Å–æ–≤
  statusSel.value = 'all';

  // –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º ¬´–ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ today¬ª
  showToday = true;
  renderTable();          // —Ä–∏—Å—É–µ–º –∑–∞–Ω–æ–≤–æ

  updateParentOptions();
});



updateIdPreview();
function updateParentOptions() {
  const type = document.getElementById('itemType').value;
  const parentSelect = document.getElementById('parentId');
  parentSelect.innerHTML = '';
  let options = [];
  if (type === 'project') {
    options = [...goalNames.entries()].map(([id, name]) => ({ id, name }));
    parentSelect.style.display = 'block';
  } else if (type === 'task') {
    if (!selectedGoalId) {
      parentSelect.style.display = 'none';
      document.getElementById('idPreview').textContent = 'ID –±—É–¥–µ—Ç: ...';
      return;
    }
    options = [...projectNames.entries()]
      .filter(([id]) => id.startsWith(selectedGoalId + '_'))
      .map(([id, name]) => ({ id, name }));
    parentSelect.style.display = 'block';
  } else {
    parentSelect.style.display = 'none';
  }
  parentSelect.appendChild(new Option('-- select --', ''));
  options.forEach(opt => {
    const option = new Option(`${opt.name} (${opt.id})`, opt.id);
    parentSelect.appendChild(option);
  });
  updateIdPreview();
}
</script>
</body>
</html>
